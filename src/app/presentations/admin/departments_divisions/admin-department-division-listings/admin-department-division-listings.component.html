<div class="p-4">
    <div class="flex justify-content-between align-items-center mb-4">
        <h1 class="text-3xl font-bold text-primary">
            Department & Division Management
        </h1>
        <div class="flex gap-2">
            <p-button
                label="Add Department"
                icon="pi pi-plus"
                class="p-button-success"
                (onClick)="showAddDepartmentDialog()"
            >
            </p-button>
        </div>
    </div>

    <p-table
        [value]="departments"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} departments"
        [globalFilterFields]="['name', 'abbreviation', 'description']"
        dataKey="id"
        styleClass="p-datatable-gridlines"
    >
        <ng-template pTemplate="caption">
            <div class="flex justify-content-between align-items-center">
                <h2 class="text-xl font-semibold">Departments</h2>
            </div>
        </ng-template>

        <ng-template pTemplate="header">
            <tr>
                <th style="width: 3rem">
                    <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                </th>
                <th pSortableColumn="name" style="min-width: 12rem">
                    Name <p-sortIcon field="name"></p-sortIcon>
                </th>

                <th style="min-width: 15rem">Vision</th>
                <th style="min-width: 15rem">Mission</th>
                <th style="min-width: 8rem">Divisions</th>
                <th style="min-width: 10rem">Actions</th>
            </tr>
        </ng-template>

        <ng-template
            pTemplate="body"
            let-department
            let-expanded="expanded"
            let-rowIndex="rowIndex"
        >
            <tr>
                <td>
                    <p-tableCheckbox [value]="department"></p-tableCheckbox>
                </td>
                <td>
                    <div class="flex align-items-center gap-2">
                        <strong class="text-primary"
                            >{{ department.name }} ({{
                                department.abbreviation
                            }})
                        </strong>
                        <p-button
                            type="button"
                            pRipple
                            [pRowToggler]="department"
                            class="p-button-text p-button-rounded p-button-plain"
                            [icon]="
                                expanded
                                    ? 'pi pi-chevron-down'
                                    : 'pi pi-chevron-right'
                            "
                        >
                        </p-button>
                    </div>
                </td>

                <td>
                    <div
                        class="text-overflow-ellipsis"
                        [title]="department.vision"
                    >
                        {{ department.vision | slice : 0 : 100 }}
                        <span *ngIf="department.vision?.length > 100">...</span>
                    </div>
                </td>
                <td>
                    <div
                        class="text-overflow-ellipsis"
                        [title]="department.mission"
                    >
                        {{ department.mission | slice : 0 : 100 }}
                        <span *ngIf="department.mission?.length > 100"
                            >...</span
                        >
                    </div>
                </td>
                <td class="text-center">
                    {{ department.divisions.length }}
                </td>
                <td>
                    <div class="flex gap-1">
                        <p-button
                            icon="pi pi-pencil"
                            class="p-button-rounded p-button-text p-button-warning"
                            pTooltip="Edit Department"
                            (onClick)="editDepartment(department)"
                        >
                        </p-button>
                        <p-button
                            icon="pi pi-plus"
                            class="p-button-rounded p-button-text p-button-success"
                            pTooltip="Add Division"
                            (onClick)="addDivision(department)"
                        >
                        </p-button>
                        <p-button
                            icon="pi pi-trash"
                            class="p-button-rounded p-button-text p-button-danger"
                            pTooltip="Delete Department"
                            (onClick)="deleteDepartment(department)"
                        >
                        </p-button>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="rowexpansion" let-department>
            <tr>
                <td colspan="7">
                    <div class="p-3">
                        <!-- Department Details -->
                        <div class="grid mb-4">
                            <div class="col-12 md:col-6">
                                <h4 class="text-primary mb-2">Vision</h4>
                                <p class="text-sm line-height-3">
                                    {{
                                        department.vision || "No vision defined"
                                    }}
                                </p>
                            </div>
                            <div class="col-12 md:col-6">
                                <h4 class="text-primary mb-2">Mission</h4>
                                <p class="text-sm line-height-3">
                                    {{
                                        department.mission ||
                                            "No mission defined"
                                    }}
                                </p>
                            </div>
                        </div>

                        <!-- Divisions Table -->
                        <div
                            *ngIf="
                                department.divisions &&
                                department.divisions.length > 0
                            "
                        >
                            <div
                                class="flex justify-content-between align-items-center mb-3"
                            >
                                <h4 class="text-primary">
                                    Divisions ({{
                                        department.divisions.length
                                    }})
                                </h4>
                                <p-button
                                    label="Add Division"
                                    icon="pi pi-plus"
                                    class="p-button-sm p-button-success"
                                    (onClick)="addDivision(department)"
                                >
                                </p-button>
                            </div>

                            <p-table
                                [value]="department.divisions"
                                styleClass="p-datatable-sm"
                                dataKey="id"
                            >
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th style="width: 3rem">Status</th>
                                        <th>Division Name</th>
                                        <th>Abbreviation</th>
                                        <th>Description</th>
                                        <th style="width: 8rem">Actions</th>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="body" let-division>
                                    <tr
                                        [class]="{
                                            'inactive-row': !division.isActive
                                        }"
                                    >
                                        <td>
                                            <p-tag
                                                [value]="
                                                    division.isActive
                                                        ? 'Active'
                                                        : 'Inactive'
                                                "
                                                [severity]="
                                                    division.isActive
                                                        ? 'success'
                                                        : 'danger'
                                                "
                                                [rounded]="true"
                                            >
                                            </p-tag>
                                        </td>
                                        <td>
                                            <strong>{{ division.name }}</strong>
                                        </td>
                                        <td>
                                            <p-tag
                                                [value]="division.abbreviation"
                                                severity="info"
                                                [rounded]="true"
                                            >
                                            </p-tag>
                                        </td>
                                        <td>
                                            <div
                                                class="text-overflow-ellipsis"
                                                [title]="division.description"
                                            >
                                                {{
                                                    division.description
                                                        | slice : 0 : 80
                                                }}
                                                <span
                                                    *ngIf="
                                                        division.description
                                                            ?.length > 80
                                                    "
                                                    >...</span
                                                >
                                            </div>
                                        </td>
                                        <td>
                                            <div class="flex gap-1">
                                                <p-button
                                                    icon="pi pi-pencil"
                                                    class="p-button-rounded p-button-text p-button-warning p-button-sm"
                                                    pTooltip="Edit Division"
                                                    (onClick)="
                                                        editDivision(division)
                                                    "
                                                >
                                                </p-button>
                                            </div>
                                        </td>
                                    </tr>
                                </ng-template>

                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td colspan="5" class="text-center p-4">
                                            <div
                                                class="flex flex-column align-items-center gap-2"
                                            >
                                                <i
                                                    class="pi pi-info-circle text-4xl text-400"
                                                ></i>
                                                <span
                                                    >No divisions found for this
                                                    department</span
                                                >
                                                <p-button
                                                    label="Add First Division"
                                                    icon="pi pi-plus"
                                                    class="p-button-sm"
                                                    (onClick)="
                                                        addDivision(department)
                                                    "
                                                >
                                                </p-button>
                                            </div>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                </td>
            </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7" class="text-center p-4">
                    <div class="flex flex-column align-items-center gap-3">
                        <i class="pi pi-info-circle text-6xl text-400"></i>
                        <span class="text-xl">No departments found</span>
                        <p-button
                            label="Add First Department"
                            icon="pi pi-plus"
                            class="p-button-lg"
                            (onClick)="showAddDepartmentDialog()"
                        >
                        </p-button>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>
</div>

<!-- Dialogs will be added here for CRUD operations -->
<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>
